<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PACKAGE KNIGHT WIZARD ‚Äî Brython Delivery</title>
<style>
  :root{
    --bg:black; --panel:black; --ink:#9eba8f; --muted:#91a1aa;
    --accent:#d9b36a; --outline:#ad5b44; --slot:#0f1318;
    --gap:16px; --slot-size:100px;              /* desktop/base slot size */
    --gold-soft:#d9b36a; --ice-soft:#8a9fb5; --btnclr:#0f1318;
    --design-max: 500px;                        /* max layout width */

    /* Delivery map */
    --wrap: 500; --w: 30; --h: 30;
    --path:#a36f4b; --grass:#38452e; --tree:#2c6a3f; --rock:#6f818f; --water:#3da3d5;
    --accent-red:#ff5a5a; --player:#ffffff;
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font:15px/1.45 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    display:flex; align-items:flex-start; justify-content:center;
    overflow-x:hidden;
  }

  .wrap{
    padding:0;
    display:flex; flex-direction:column; align-items:center; gap:var(--gap);
    width:min(100vw, var(--design-max));
  }

  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    padding:0;
    background:var(--panel);
    border:0px dashed var(--outline); border-radius:12px;
    width:100%;
  }
  .title{ margin:0; font-size:20px; color:var(--ink); letter-spacing:.5px }
  .stats{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .btn-buy{
    border:1px dashed var(--outline); background:var(--btnclr); color:var(--ink);
    border-radius:10px; padding:12px 20px; font-weight:700; cursor:pointer;
  }
  .btn-buy:hover{ border-color:var(--accent) }
  .stat{ font-weight:700; padding:5px 10px; border:0px dashed var(--outline); border-radius:8px; background:#12171d; }
  .stat.coins{ color:var(--gold-soft); }
  .stat.mana{ color:var(--ice-soft); }

  .main{
    display:flex; flex-direction:column; gap:var(--gap);
    margin-top:16px; align-items:center; flex-wrap:nowrap;
    width:100%;
  }

  .wizardKnight, .inv, .delivery { width:100%; }

  .card{
    background:var(--panel);
    border:1px dashed var(--outline); border-radius:12px; padding:14px;
    display:grid; align-items:center; gap:10px;
  }
  .subhead{
    font-size:12px; color:var(--muted); margin:0;
    text-transform:uppercase; letter-spacing:.06em; text-align:center;
  }

  .vstack{
    display:flex; flex-direction:column; align-items:center; gap:10px;
    width:auto;
  }
  .wizardKnight .wk-row{
    display:grid; grid-template-columns: repeat(2, max-content);
    gap:16px 32px; justify-content:center; align-items:start;
  }

  .slot, .knight-slot, .inv-slot{
    width:var(--slot-size); height:var(--slot-size);
    background:var(--slot); border:1px dashed var(--outline);
    border-radius:12px; display:grid; place-items:center; cursor:pointer;
    position:relative; overflow:hidden;
  }
  .slot:hover, .knight-slot:hover, .inv-slot:hover{ border-color:var(--accent); }
  .placeholder{ color:var(--muted); font-size:12px; opacity:.9; }

  .inv .grid{
    display:grid;
    grid-template-columns: repeat(4, var(--slot-size));
    grid-auto-rows: var(--slot-size);
    gap:12px;
    justify-content:center;
    overflow:hidden;
  }

  .pkg{
    --ring:transparent;
    display:grid; place-items:center; gap:4px; text-align:center;
    width:calc(var(--slot-size) - 16px); height:calc(var(--slot-size) - 16px);
    border-radius:10px; user-select:none; border:1px dashed var(--outline);
    background:var(--ring);
    transition:transform .06s ease, box-shadow .12s ease, border-color .12s ease;
    pointer-events:auto; cursor:pointer;
  }
  .pkg .icon{ font-size:32px; line-height:1 }
  .pkg .tag{
    margin-top:2px; font-size:11px; color:var(--muted);
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:90%;
  }
  .pkg.is-selected{ border-color:var(--accent); transform:scale(0.98); }
  .board-selecting .slot, .board-selecting .knight-slot, .board-selecting .inv-slot{
    outline:1px dashed rgba(217,179,106,.25);
  }

  .actions{ display:flex; gap:8px; justify-content:center; }
  .btn{
    border:1px dashed var(--outline); background:var(--btnclr);
    color:var(--ink); border-radius:10px; padding:12px 20px; font-weight:600;
    cursor:pointer; transition:transform .04s ease, border-color .12s ease;
  }
  .btn:hover{ border-color:var(--accent) }
  .btn[disabled]{ opacity:.5; cursor:not-allowed; }
  .divider{ width:100%; height:1px; background:var(--outline); }

  /* Delivery grid (reuses wilderness styles) */
  .grid{
    width:calc(var(--wrap)*1px);height:calc(var(--wrap)*1px);
    display:grid;grid-template-columns:repeat(var(--w),1fr);grid-template-rows:repeat(var(--h),1fr);
    border:1px solid #25303a;background:#0f1318;box-shadow:0 0 0 1px #141b22 inset,0 4px 24px rgba(0,0,0,.35);overflow:hidden;
  }
  .cell{
    display:flex;align-items:center;justify-content:center;font-weight:800;aspect-ratio:1/1;
    --tight:1.2;font-size:calc((var(--wrap)*1px)/var(--w)*var(--tight));line-height:1;
    min-width:0;min-height:0;overflow:hidden;contain:size layout paint;
    text-shadow:0 0 3px currentColor,0 0 3px currentColor;transition:opacity 80ms linear;
  }
  .t-path{color:var(--path)} .t-grass{color:var(--grass)} .t-tree{color:var(--tree)}
  .t-rock{color:var(--rock)} .t-water{color:var(--water)}
  .t-arrow{color:var(--accent-red);transform:rotate(-90deg)} .t-x{color:var(--accent-red)}
  .t-player{color:var(--player)}
  .fog-unseen { color:#000 !important; opacity:1 !important; }
  .fog-seen   { color:#000 !important; opacity:.20; }

  .legend{width:100%;display:flex;flex-wrap:wrap;gap:10px;justify-content:center;color:#8da2b2;font-size:12px}
  .legend b{color:#cfe3ef}
  .msg{color:#9fc46b;font-weight:600}

  @media (max-width: 500px){
    :root{ --slot-size: calc((100vw - 36px - 28px) / 4); }
    .wrap{ width:100vw; }
    .wizardKnight .wk-row{ gap:12px 24px; }
    .btn, .btn-buy{ padding:10px 14px; }
  }
</style>

<!-- Brython -->
<script src="https://cdn.jsdelivr.net/npm/brython@3.12.3/brython.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/brython@3.12.3/brython_stdlib.js"></script>
</head>
<body onload="brython()">
  <div class="wrap">
    <h1 class="title">PACKAGE KNIGHT WIZARD</h1>
    <header class="topbar">
      <div class="stats">
        <button class="btn-buy" id="btn-buy-mana" type="button">Buy Mana Crystal (10 Coins)</button>
        <div class="stat coins" id="coins-readout">Coins: 10</div>
        <div class="stat mana" id="mana-readout">Mana Crystals: 50</div>
      </div>
    </header>

    <div class="main" id="board">
      <!-- wizardKnight -->
      <section class="card wizardKnight" aria-label="wizardKnight">
        <div class="wk-row">
          <div class="vstack" aria-label="Package Portal section">
            <div class="subhead">Package Portal</div>
            <div class="slot" id="portal-slot" aria-label="Portal slot">
              <div class="placeholder">empty</div>
            </div>
            <div class="actions">
              <button class="btn" id="btn-activate" type="button">Activate (15 Mana)</button>
            </div>
          </div>

          <div class="vstack" aria-label="Knight section">
            <div class="subhead">Package Knight</div>
            <div class="knight-slot" id="knight-slot" aria-label="Knight slot">
              <div class="placeholder">no package</div>
            </div>
            <div class="actions">
              <button class="btn" id="btn-begin" type="button" disabled>Begin Delivery</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Inventory -->
      <section class="card inv" aria-label="Inventory">
        <div class="subhead">Inventory</div>
        <div class="grid" id="inv-grid">
          <div class="inv-slot" aria-label="Inventory slot 1"><div class="placeholder">empty</div></div>
          <div class="inv-slot" aria-label="Inventory slot 2"><div class="placeholder">empty</div></div>
          <div class="inv-slot" aria-label="Inventory slot 3"><div class="placeholder">empty</div></div>
          <div class="inv-slot" aria-label="Inventory slot 4"><div class="placeholder">empty</div></div>
        </div>
      </section>

      <!-- Delivery (the game renders here) -->
      <section class="card delivery" aria-label="Delivery">
        <div class="subhead">Delivery</div>

        <div class="delivery-body">
          <header style="width:100%;display:flex;justify-content:space-between;align-items:center;font-weight:600;color:#8aa2b3">
            <div class="left" style="display:flex;gap:12px;align-items:center">
              <div>Wilderness Roguelike</div>
              <div>‚Ä¢ <span id="level">Map 1/3</span></div>
            </div>
            <div class="right" style="font-size:12px">Move: <b>W A S D</b> ‚Ä¢ Restart: <b>R</b> ‚Ä¢ Fog: <b>F</b></div>
          </header>
          <div id="grid" class="grid" aria-label="map grid"></div>
          <div class="legend">
            <span><b>@</b> you (white)</span><span><b>X</b> spawn & destination (red)</span>
            <span><b>.</b> path</span><span><b>"</b> grass</span><span><b>A</b> tree ‚ùå</span>
            <span><b>a</b> boulder ‚ùå</span><span><b>~</b> water ‚ùå</span><span><b>‚û®</b> arrow ‚Üí next map</span>
            <span class="msg" id="msg"></span>
          </div>
        </div>
      </section>
    </div>
  </div>

<script type="text/python">
from browser import document, html, bind
import random, math

# ============= Basic wiring & state (coins/mana & UI) =============
mana = 50
coins = 10

mana_readout = document["mana-readout"]
coins_readout = document["coins-readout"]
btn_activate = document["btn-activate"]
btn_begin = document["btn-begin"]
btn_buy_mana = document["btn-buy-mana"]
board = document["board"]
portal_slot = document["portal-slot"]
knight_slot = document["knight-slot"]

def update_currency_ui():
    mana_readout.text = f"Mana Crystals: {mana}"
    coins_readout.text = f"Coins: {coins}"
    btn_activate.disabled = (mana < 15)
    btn_buy_mana.disabled = (coins < 10)

def has_knight_package():
    return len(knight_slot.select(".pkg")) > 0

def update_begin_enabled():
    btn_begin.disabled = not has_knight_package()

update_currency_ui()
update_begin_enabled()

# ============= Inventory / package generation =============
Sizes = [ {"name":"small","c":1}, {"name":"large","c":2}, {"name":"huge","c":3} ]
Weights = [ {"name":"light","c":1}, {"name":"iron-plated","c":2}, {"name":"supermassive","c":3} ]
Grips = [ {"name":"sticky","c":1}, {"name":"manageable","c":2}, {"name":"slimy","c":3} ]
Types = [
    {"name":"letter","c":1,"icon":"‚úâÔ∏è"},
    {"name":"parcel","c":2,"icon":"üì¶"},
    {"name":"crate","c":3,"icon":"üóÉÔ∏è"}
]
Destinations = [
    "Rockslide Inn, New Claudia",
    "Red Temple, Pilgrim Lake",
    "Wuulk's Spawning Grounds, Badlands",
]
Senders = [
    {"name":"Sibil the Miraculous","m":5,"c":0},
    {"name":"Bork the Wealthy","m":2,"c":30},
]
SpecialInstructions = [
    "Do not shake, and definitely do not light on fire. I'll see you in the morning.",
    "Package contains a manuscript. Never open and keep out of reach of children and animals.",
    "Originally intended for a lover, but now? My mother.",
    "Very old. Over 5,000 years, it says. Handle with care.",
    "Wizard's eyes only. No naughty knights allowed.",
    "It is as though I find things to send you just to keep my knight employed.",
    "I found the attached in an inferno. I think it would be of great personal interest to you.",
    "There's a new tower going up on the cliffs in the Badlands. How tacky.",
    "It's my histories in bound volumes. The originals. Well, the onlys.",
    "Per our discussion. You may find my failed attempts disturbing, but it will be good for your garden.",
    "Firstly, I love goblins. To that end, I commit to returning this useless and unassuming artifact.",
    "A generation ago, this valley was home to more than just Wizards and Knaves.",
    "ATTACHED: A very small piece of my first oubliette. Don't do anything strange with it.",
    "Give this to the Violet Cloak, if you can. Please burn it at the address provided if no.",
    "This is everything I know about Wandering Ones, including one of their masks.",
    "Hey, Knight: Wizards are paranoid. They believe some of their order are dead and replaced by knights.",
    "I can't stay. Lanturns gathering by night, lighting up the hills. I'm already gone."
]

def pick(arr): return arr[random.randrange(len(arr))]

def make_placeholder(slot_el):
    ph = html.DIV("empty", Class="placeholder")
    if "knight-slot" in slot_el.class_name:
        ph.text = "no package"
    return ph

def make_package_chip():
    size = pick(Sizes)
    weight = pick(Weights)
    grip = pick(Grips)
    typ = pick(Types)
    dest = pick(Destinations)
    sender = pick(Senders)
    note = pick(SpecialInstructions)
    baseCoin = size["c"] + weight["c"] + grip["c"] + typ["c"]
    coinTotal = baseCoin + sender["c"]
    manaBonus = sender["m"]

    desc_lines = [
        f"A {size['name']}, {weight['name']}, {grip['name']} {typ['name']}.",
        f"Base value: {baseCoin} coin(s).",
        f"Destination: {dest}",
        f"Sender: {sender['name']} (m{sender['m']}{', c'+str(sender['c']) if sender['c'] else ''})",
        "",
        note
    ]
    chip = html.DIV(Class="pkg")
    chip.attrs["data-name"] = typ["name"].title()
    chip.attrs["data-icon"] = typ["icon"]
    chip.attrs["data-desc"] = "\n".join(desc_lines)
    chip.attrs["data-coins-base"] = str(baseCoin)
    chip.attrs["data-coins-sender"] = str(sender["c"])
    chip.attrs["data-coins-total"] = str(coinTotal)
    chip.attrs["data-mana-sender"] = str(manaBonus)
    chip <= html.DIV(typ["icon"], Class="icon")
    chip <= html.DIV(typ["name"].title(), Class="tag")
    return chip

@bind(btn_activate, "click")
def on_activate(ev):
    global mana
    if mana < 15: return
    mana -= 15
    update_currency_ui()
    chip = make_package_chip()
    portal_slot.clear()
    portal_slot <= chip

@bind(document["btn-buy-mana"], "click")
def on_buy_mana(ev):
    global coins, mana
    if coins >= 10:
        coins -= 10
        mana += 1
        update_currency_ui()

# ============= Click-to-move & selection (Brython-safe) =============
selected_chip = None
selected_from = None

def select_chip_visual(chip, on):
    if on:
        chip.classList.add("is-selected")
        board.classList.add("board-selecting")
    else:
        chip.classList.remove("is-selected")
        board.classList.remove("board-selecting")

def clear_selection():
    global selected_chip, selected_from
    if selected_chip:
        select_chip_visual(selected_chip, False)
    selected_chip = None
    selected_from = None

def safe_closest(el, selector):
    """Return el.closest(selector) or None; avoid raising when no match."""
    try:
        return el.closest(selector)
    except Exception:
        return None

def move_chip_to(slot):
    global selected_chip, selected_from
    if not selected_chip or slot is None: return
    if slot == selected_from:
        clear_selection()
        return
    slot.clear()
    slot <= selected_chip
    if selected_from and len(selected_from.children) == 0:
        selected_from <= make_placeholder(selected_from)
    ph = safe_closest(selected_chip, ".placeholder")
    if ph: ph.remove()
    clear_selection()
    update_begin_enabled()

@bind(board, "click")
def board_click(ev):
    # ignore button clicks
    tgt = ev.target
    if tgt.tagName == "BUTTON": return

    chip = safe_closest(tgt, ".pkg")
    slot = safe_closest(tgt, ".slot, .knight-slot, .inv-slot")

    if chip is not None:
        ev.stopPropagation()
        global selected_chip, selected_from
        if selected_chip and selected_chip is chip:
            # second click on same chip = deselect
            clear_selection()
            return
        if selected_chip:
            select_chip_visual(selected_chip, False)
        selected_chip = chip
        selected_from = chip.parent
        select_chip_visual(chip, True)
        return

    if slot is not None and selected_chip is not None:
        move_chip_to(slot)
        return

    clear_selection()

# ============= DELIVERY GAME (Brython wilderness, fast FOV) =============
grid_el = document["grid"]; level_el = document["level"]; msg_el = document["msg"]
W, H, MAPS = 30, 30, 3
R = 7
T_GRASS, T_TREE, T_ROCK, T_DIRT, T_WATER, T_ARROW, T_DEST, T_SPAWN, T_PLAYER = '"','A','a','.','~','‚û®','X','X','@'
CLASS = { '"':'t-grass','A':'t-tree','a':'t-rock','.' :'t-path','~':'t-water','‚û®':'t-arrow','X':'t-x','@':'t-player' }

def in_bounds(x,y): return 0 <= x < W and 0 <= y < H
def is_blocked(ch): return ch in (T_TREE, T_ROCK, T_WATER)
def msg(s=""): msg_el.text = s

cells = []
def build_grid_dom():
    grid_el.clear()
    for _ in range(W*H):
        grid_el <= html.DIV(Class="cell")
    flat = list(grid_el.children)
    del cells[:]
    for y in range(H):
        row = []
        for x in range(W):
            row.append(flat[y*W + x])
        cells.append(row)

def gen_trail_map(final_part=False):
    m = [[T_GRASS for _ in range(W)] for _ in range(H)]
    cx = W//2
    for y in range(1,H-1):
        for x in range(1,W-1):
            d = abs(x-cx)/(W/2)
            treeP = max(0.0, (d**1.5)*0.70 + 0.04)
            rockP = (d**1.2)*0.05
            r = random.random()
            if r < treeP: m[y][x] = T_TREE
            elif r < treeP + rockP: m[y][x] = T_ROCK
    borderL = 4 + random.randrange(3); borderR = 4 + random.randrange(3)
    for y in range(H):
        for x in range(borderL): m[y][x] = T_TREE
        for x in range(W-borderR, W): m[y][x] = T_TREE
    tx = random.randrange(W-10)+5; ty = H-2; startX = tx
    while ty > 1:
        m[ty][tx] = T_DIRT
        if random.random()<0.25 and tx+1 < W-1: m[ty][tx+1] = T_DIRT
        if random.random()<0.25 and tx-1 > 0:   m[ty][tx-1] = T_DIRT
        dx = random.choice([-1,0,1,0]); tx = max(1, min(W-2, tx+dx)); ty -= 1
        m[ty][tx] = T_DIRT
    pools = 1 + random.randrange(3)
    for _ in range(pools):
        size = 3 + random.randrange(4); tries = 0
        while True:
            sx = random.randrange(1,W-1); sy = random.randrange(1,H-1); tries += 1
            if m[sy][sx] != T_DIRT or tries >= 100: break
        pool = [(sx,sy)]
        def ok(x,y): return m[y][x] not in (T_DIRT,T_ARROW,T_DEST,T_SPAWN)
        while len(pool) < size:
            px,py = random.choice(pool); stepx,stepy = random.choice([(1,0),(-1,0),(0,1),(0,-1)])
            nx,ny = px+stepx, py+stepy
            if in_bounds(nx,ny) and ok(nx,ny): pool.append((nx,ny))
            if len(pool) > size*2: break
        for wx,wy in pool:
            if m[wy][wx] != T_DIRT: m[wy][wx] = T_WATER
    m[H-2][startX] = T_SPAWN
    topX = tx
    for sx in range(W):
        cand = max(1, min(W-2, tx + (-math.ceil(sx/2) if sx%2 else math.ceil(sx/2))))
        if m[1][cand] == T_DIRT: topX = cand; break
    m[1][topX] = T_DEST if final_part else T_ARROW
    return m

state = {
  "mapIndex":0, "fog":True, "map":None,
  "px":0, "py":0, "prev_px":0, "prev_py":0,
  "seenMask":None, "visMask":None, "gameOver":False
}
maps = []
base_class = [[None]*W for _ in range(H)]

def make_mask(val=False): return [[val for _ in range(W)] for _ in range(H)]

def paint_static_map():
    m = state["map"]
    for y in range(H):
        for x in range(W):
            ch = m[y][x]
            el = cells[y][x]
            el.text = ch
            base_class[y][x] = "cell " + CLASS.get(ch, "t-grass")

def fov_compute():
    px, py = state["px"], state["py"]
    prev_vis = state["visMask"]
    vis = make_mask(False)
    x0, x1 = max(0, px-R), min(W-1, px+R)
    y0, y1 = max(0, py-R), min(H-1, py+R)
    for y in range(y0, y1+1):
        for x in range(x0, x1+1):
            dx, dy = x-px, y-py
            if dx*dx + dy*dy > R*R: continue
            steps = max(abs(dx), abs(dy))
            stepx = dx/steps if steps else 0
            stepy = dy/steps if steps else 0
            cx, cy = float(px), float(py)
            for _ in range(steps+1):
                ix, iy = int(round(cx)), int(round(cy))
                if not in_bounds(ix,iy): break
                vis[iy][ix] = True
                if is_blocked(state["map"][iy][ix]): break
                cx += stepx; cy += stepy
    for y in range(H):
        for x in range(W):
            if vis[y][x]: state["seenMask"][y][x] = True
    dirty = set()
    if prev_vis is None:
        for y in range(y0, y1+1):
            for x in range(x0, x1+1):
                dirty.add((x,y))
    else:
        for y in range(y0, y1+1):
            for x in range(x0, x1+1):
                if vis[y][x] != prev_vis[y][x]: dirty.add((x,y))
    state["visMask"] = vis
    return dirty

def fog_suffix(x,y):
    if not state["fog"]: return ""
    if not state["seenMask"][y][x]: return " fog-unseen"
    if not state["visMask"][y][x]:  return " fog-seen"
    return ""

def paint_fog(dirty, full=False):
    if full:
        for y in range(H):
            for x in range(W):
                cells[y][x].class_name = base_class[y][x] + fog_suffix(x,y)
        return
    for (x,y) in dirty:
        cells[y][x].class_name = base_class[y][x] + fog_suffix(x,y)

def paint_player():
    px0, py0 = state["prev_px"], state["prev_py"]
    if in_bounds(px0, py0):
        c0 = cells[py0][px0]
        c0.text = state["map"][py0][px0]
        c0.class_name = base_class[py0][px0] + fog_suffix(px0,py0)
    px, py = state["px"], state["py"]
    c1 = cells[py][px]
    c1.class_name = "cell t-player" + fog_suffix(px,py)
    c1.text = T_PLAYER

def load_map(idx, place_player):
    state["map"] = maps[idx]
    state["gameOver"] = False
    # spawn at bottom 'X'
    px = 1; py = H-2
    for x in range(1, W-1):
        if state["map"][H-2][x] == 'X':
            px = x; break
    if place_player:
        state["px"] = px; state["py"] = py
        state["prev_px"] = px; state["prev_py"] = py

    paint_static_map()
    if state["fog"]:
        state["seenMask"] = make_mask(False); state["visMask"] = make_mask(False)
        paint_fog(set(), full=True); paint_fog(fov_compute(), full=False)
    else:
        state["seenMask"] = make_mask(True); state["visMask"] = make_mask(True)
        paint_fog(set(), full=True)
    paint_player()
    level_el.text = f"Map {idx+1}/{MAPS}"

def init_delivery_map():
    global maps
    maps = [gen_trail_map(False), gen_trail_map(False), gen_trail_map(True)]
    state["mapIndex"] = 0; state["gameOver"] = False
    load_map(state["mapIndex"], True)
    msg("")

def award_and_consume_package():
    """On reaching the final destination, pay out and consume the package in Knight slot."""
    chip_list = knight_slot.select(".pkg")
    chip = chip_list[0] if chip_list else None
    coin_total = int(chip.attrs.get("data-coins-total","0")) if chip else 0
    mana_bonus = int(chip.attrs.get("data-mana-sender","0")) if chip else 0
    if chip:
        chip.remove()
        if len(knight_slot.children) == 0:
            knight_slot <= make_placeholder(knight_slot)
    update_begin_enabled()
    global coins, mana
    coins += coin_total; mana += mana_bonus
    update_currency_ui()
    msg(f"Delivery complete! +{coin_total} coins, +m{mana_bonus} mana. Press R to restart.")
    # Re-enable Begin for next package run
    btn_begin.disabled = True

def try_move(dx, dy):
    if state["gameOver"]: return
    nx = max(0, min(W-1, state["px"] + dx))
    ny = max(0, min(H-1, state["py"] + dy))
    t = state["map"][ny][nx]
    if is_blocked(t): return
    state["prev_px"], state["prev_py"] = state["px"], state["py"]
    state["px"], state["py"] = nx, ny

    if state["fog"]:
        dirty = fov_compute(); paint_fog(dirty, full=False)
    else:
        cells[state["prev_py"]][state["prev_px"]].class_name = base_class[state["prev_py"]][state["prev_px"]]
        cells[ny][nx].class_name = base_class[ny][nx]

    paint_player()

    if t == T_ARROW and state["mapIndex"] < MAPS-1:
        state["mapIndex"] += 1
        msg(f"Advancing to Map {state['mapIndex']+1}‚Ä¶")
        load_map(state["mapIndex"], True); msg("")
    elif t == T_DEST and state["py"] == 1 and state["mapIndex"] == MAPS-1:
        state["gameOver"] = True
        award_and_consume_package()

@bind(document, "keydown")
def on_keydown(e):
    k = (e.key or "").lower()
    if   k == "w": try_move(0,-1)
    elif k == "s": try_move(0, 1)
    elif k == "a": try_move(-1,0)
    elif k == "d": try_move(1, 0)
    elif k == "r": init_delivery_map()
    elif k == "f":
        state["fog"] = not state["fog"]
        if state["fog"]:
            state["seenMask"] = make_mask(False); state["visMask"] = make_mask(False)
            paint_fog(set(), full=True); paint_fog(fov_compute(), full=False)
        else:
            state["seenMask"] = make_mask(True); state["visMask"] = make_mask(True)
            paint_fog(set(), full=True)
        paint_player()

# Hook for the Begin button
@bind(btn_begin, "click")
def on_begin(ev):
    if btn_begin.disabled: return
    # Start the wilderness delivery
    build_grid_dom()
    init_delivery_map()
    msg("Carry the package to the final X at the top!")
    # Disable begin during run; re-enabled after payout
    btn_begin.disabled = True

# Enable Begin when a package is dropped into the Knight slot
# (we already re-check on any selection/move)
# ============= End delivery =============

</script>
</body>
</html>
