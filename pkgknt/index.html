<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PACKAGE KNIGHT WIZARD</title>
<style>
  :root{
    --bg:black; --panel:black; --ink:#9eba8f; --muted:#91a1aa;
    --accent:#d9b36a; --outline:#ad5b44; --slot:#0f1318;
    --gap:16px; --slot-size:100px;              /* desktop/base slot size */
    --gold-soft:#d9b36a; --ice-soft:#8a9fb5; --btnclr:#0f1318;
    --design-max: 500px;                        /* max layout width */
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font:15px/1.45 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    display:flex; align-items:flex-start; justify-content:center;
    overflow-x:hidden;                           /* prevent sideways scroll on mobile */
  }

  /* Centered column container with max width; stretches down to 100vw on phones */
  .wrap{
    padding:0;
    display:flex; flex-direction:column; align-items:center; gap:var(--gap);
    width:min(100vw, var(--design-max));
  }

  /* Topbar should follow container width (not 100vw) so it shrinks with .wrap */
  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    padding:0;
    background:var(--panel);
    border:0px dashed var(--outline); border-radius:12px;
    width:100%;                                   /* was 100vw */
    max-width:none;                                /* let .wrap control width */
  }
  .title{ margin:0; font-size:20px; color:var(--ink); letter-spacing:.5px }
  .stats{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .btn-buy{
    border:1px dashed var(--outline); background:var(--btnclr); color:var(--ink);
    border-radius:10px; padding:12px 20px; font-weight:700; cursor:pointer;
  }
  .btn-buy:hover{ border-color:var(--accent) }
  .stat{ font-weight:700; padding:5px 10px; border:0px dashed var(--outline); border-radius:8px; background:#12171d; }
  .stat.coins{ color:var(--gold-soft); }
  .stat.mana{ color:var(--ice-soft); }

  /* Column layout */
  .main{
    display:flex; flex-direction:column; gap:var(--gap);
    margin-top:16px; align-items:center; flex-wrap:nowrap;
    width:100%;
  }

  /* Cards follow container width; no fixed/min widths that would overflow phones */
  .wizardKnight, .inv, .delivery { width:100%; }

  /* Card base */
  .card{
    background:var(--panel);
    border:1px dashed var(--outline); border-radius:12px; padding:14px;
    display:grid; align-items:center; gap:10px;
  }
  .subhead{
    font-size:12px; color:var(--muted); margin:0;
    text-transform:uppercase; letter-spacing:.06em; text-align:center;
  }

  /* STACKS */
  .vstack{
    display:flex; flex-direction:column; align-items:center; gap:10px;
    width:auto;
  }
  .wizardKnight .wk-row{
    display:grid; grid-template-columns: repeat(2, max-content);
    gap:16px 32px; justify-content:center; align-items:start;
  }

  /* Slots */
  .slot, .knight-slot, .inv-slot{
    width:var(--slot-size); height:var(--slot-size);
    background:var(--slot); border:1px dashed var(--outline);
    border-radius:12px; display:grid; place-items:center; cursor:pointer;
    position:relative; overflow:hidden;
  }
  .slot:hover, .knight-slot:hover, .inv-slot:hover{ border-color:var(--accent); }
  .placeholder{ color:var(--muted); font-size:12px; opacity:.9; }

  /* Inventory (horizontal row of 4) */
  .inv .grid{
    display:grid;
    grid-template-columns: repeat(4, var(--slot-size));   /* always 4 across */
    grid-auto-rows: var(--slot-size);
    gap:12px;
    justify-content:center;
    overflow:hidden;                                      /* no horizontal scroll on phones */
  }

  /* Package chip */
  .pkg{
    --ring:transparent;
    display:grid; place-items:center; gap:4px; text-align:center;
    width:calc(var(--slot-size) - 16px); height:calc(var(--slot-size) - 16px);
    border-radius:10px; user-select:none; border:1px dashed var(--outline);
    background:var(--ring);
    transition:transform .06s ease, box-shadow .12s ease, border-color .12s ease;
    pointer-events:auto; cursor:pointer;
  }
  .pkg .icon{ font-size:32px; line-height:1 }
  .pkg .tag{
    margin-top:2px; font-size:11px; color:var(--muted);
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:90%;
  }
  .pkg.is-selected{ border-color:var(--accent); transform:scale(0.98); }
  .board-selecting .slot, .board-selecting .knight-slot, .board-selecting .inv-slot{
    outline:1px dashed rgba(217,179,106,.25);
  }

  /* Buttons */
  .actions{ display:flex; gap:8px; justify-content:center; }
  .btn{
    border:1px dashed var(--outline); background:var(--btnclr);
    color:var(--ink); border-radius:10px; padding:12px 20px; font-weight:600;
    cursor:pointer; transition:transform .04s ease, border-color .12s ease;
  }
  .btn:hover{ border-color:var(--accent) }
  .btn[disabled]{ opacity:.5; cursor:not-allowed; }
  .divider{ width:100%; height:1px; background:var(--outline); }

  /* Overlay (long-press) */
  .overlay-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; z-index:999; }
  .overlay-card{ width:min(480px, 92vw); background:var(--bg); border:1px dashed var(--outline); border-radius:14px; padding:14px; display:flex; flex-direction:column; gap:10px; }
  .overlay-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .overlay-title{ font-size:14px; text-transform:uppercase; letter-spacing:.06em; color:var(--muted); }
  .overlay-close{ border:1px dashed var(--outline); background:#1a1f25; color:var(--ink); border-radius:8px; padding:4px 8px; cursor:pointer; }
  .overlay-body{ display:flex; gap:10px; align-items:flex-start; }
  .overlay-icon{ font-size:40px; line-height:1; }
  .overlay-texts{ display:flex; flex-direction:column; gap:6px; }
  .overlay-name{ font-weight:700; }
  .overlay-desc{ color:var(--muted); font-size:13px; white-space:pre-line; }
  .overlay-metrics{ font-size:12px; color:var(--muted); }

  /* Delivery panel log */
  .battle-log{
    width:100%;
    flex:1;
    min-height:260px;
    background:#0f1318;
    border:1px dashed var(--outline);
    border-radius:10px;
    padding:10px;
    overflow:auto;
    white-space:pre-wrap;
  }

  /* ===== Phone fit: shrink slots so 4-wide always fits viewport ===== */
  @media (max-width: 500px){
    /* Compute slot size so: 4*slot + 3*gap(12) + card padding(14*2) fits 100vw */
    :root{
      --slot-size: calc((100vw - 36px - 28px) / 4);  /* 36 = 3 gaps, 28 = card paddings */
    }
    .wrap{ width:100vw; }            /* container follows viewport on phones */
    .wizardKnight .wk-row{ gap:12px 24px; }
    .btn, .btn-buy{ padding:10px 14px; }
  }
</style>

</head>
<body>
  <div class="wrap">
    <!-- Title -->
    <h1 class="title">PACKAGE KNIGHT WIZARD</h1>
    <header class="topbar">
      <div class="stats">
        <button class="btn-buy" id="btn-buy-mana" type="button">Buy Mana Crystal (10 Coins)</button>
        <div class="stat coins" id="coins-readout">Coins: 10</div>
        <div class="stat mana" id="mana-readout">Mana Crystals: 50</div>
      </div>
    </header>

    <!-- Board -->
    <div class="main" id="board">
      <!-- wizardKnight (merged) -->
      <section class="card wizardKnight" aria-label="wizardKnight">
        <div class="wk-row">
          <!-- Column 1: Portal slot + Activate -->
          <div class="vstack" aria-label="Package Portal section">
            <div class="subhead">Package Portal</div>
            <div class="slot" id="portal-slot" aria-label="Portal slot">
              <div class="placeholder">empty</div>
            </div>
            <div class="actions">
              <button class="btn" id="btn-activate" type="button">Activate (15 Mana)</button>
            </div>
          </div>

          <!-- Column 2: Knight header + slot + Begin -->
          <div class="vstack" aria-label="Knight section">
            <div class="subhead">Package Knight</div>
            <div class="knight-slot" aria-label="Knight slot">
              <div class="placeholder">no package</div>
            </div>
            <div class="actions">
              <button class="btn" id="btn-begin" type="button">Begin Delivery</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Inventory -->
      <section class="card inv" aria-label="Inventory">
        <div class="subhead">Inventory</div>
        <div class="grid">
          <div class="inv-slot" aria-label="Inventory slot 1"><div class="placeholder">empty</div></div>
          <div class="inv-slot" aria-label="Inventory slot 2"><div class="placeholder">empty</div></div>
          <div class="inv-slot" aria-label="Inventory slot 3"><div class="placeholder">empty</div></div>
          <div class="inv-slot" aria-label="Inventory slot 4"><div class="placeholder">empty</div></div>
        </div>
      </section>

      <!-- Delivery -->
      <section class="card delivery" aria-label="Delivery">
        <div class="subhead">Delivery</div>
        <div id="battle-log" class="battle-log" aria-live="polite"></div>
      </section>
    </div>
  </div>

<script>
/* Click-to-move + Mana/Coins + Generator + Long-press overlay + Delivery log + Autobattle hook */
(function(){
  const board = document.getElementById('board');
  const SLOT_SEL = '.slot, .knight-slot, .inv-slot';
  const portalSlot = document.getElementById('portal-slot');
  const battleLogEl = document.getElementById('battle-log');

  // Currency state
  let mana = 50;
  let coins = 10;

  const manaReadout = document.getElementById('mana-readout');
  const coinsReadout = document.getElementById('coins-readout');
  const btnActivate = document.getElementById('btn-activate');
  const btnBegin = document.getElementById('btn-begin');
  const btnBuyMana = document.getElementById('btn-buy-mana');

  function updateCurrencyUI(){
    manaReadout.textContent = `Mana Crystals: ${mana}`;
    coinsReadout.textContent = `Coins: ${coins}`;
    btnActivate.disabled = mana < 15;
    btnBuyMana.disabled = coins < 10;
  }

  // --- Gate "Begin Delivery" on Knight slot contents ---
  const knightSlot = document.querySelector('.knight-slot');
  function hasKnightPackage(){ return !!knightSlot.querySelector('.pkg'); }
  function updateBeginEnabled(){ btnBegin.disabled = !hasKnightPackage(); }
  updateBeginEnabled();
  new MutationObserver(updateBeginEnabled).observe(knightSlot, { childList:true, subtree:true });

  // --- Delivery log helpers (no change if you already have these) ---
  function clearBattleLog(){ battleLogEl.textContent = ''; }
  function streamLog(lines, delay=30){
    clearBattleLog();
    let i = 0;
    (function step(){
      if(i >= lines.length) return;
      battleLogEl.insertAdjacentText('beforeend', lines[i++] + '\n');
      battleLogEl.scrollTop = battleLogEl.scrollHeight;
      setTimeout(step, delay);
    })();
  }

  // --- Begin Delivery: Knight vs Wandering Blade, import from Netlify ---
  btnBegin.addEventListener('click', async (e) => {
    e.stopPropagation();
    if (btnBegin.disabled) return;

    clearBattleLog();
    battleLogEl.textContent = 'Starting delivery battle...';

    try {
      // Use HTTPS to avoid mixed-content blocks
      const { runAutobattle } = await import('https://reptileroom.netlify.app/pkgknt/autobattle.js');

      const result = runAutobattle({ fighters: ['Knight','Wandering Blade'] });
      streamLog(result.log, 30);

      // TODO: on victory, award coins/mana using the package's data, then clear the Knight slot.
      // if (result.winner === 'Knight') { ... }

    } catch (err) {
      battleLogEl.textContent =
        'Could not load autobattle.js from Netlify.\n' +
        'Tip: ensure this page also runs on https://reptileroom.netlify.app (same origin).\n\n' +
        String(err);
    }
  });


  updateCurrencyUI();
  updateBeginEnabled();

  // Buy mana: 10 coins -> +1 mana
  btnBuyMana.addEventListener('click', (e)=>{
    e.stopPropagation();
    if (coins >= 10){
      coins -= 10; mana += 1;
      updateCurrencyUI();
    }
  });

  // ===== Generator Data =====
  const Sizes = [ {name:'small', c:1}, {name:'large', c:2}, {name:'huge', c:3} ];
  const Weights = [ {name:'light', c:1}, {name:'iron-plated', c:2}, {name:'supermassive', c:3} ];
  const Grips = [ {name:'sticky', c:1}, {name:'manageable', c:2}, {name:'slimy', c:3} ];
  const Types = [
    {name:'letter', c:1, icon:'✉️'},
    {name:'parcel', c:2, icon:'📦'},
    {name:'crate',  c:3, icon:'🗃️'}
  ];
  const Destinations = [
    'Rockslide Inn, New Claudia',
    'Red Temple, Pilgrim Lake',
    "Wuulk's Spawning Grounds, Badlands",
  ];
  const Senders = [
    {name:'Sibil the Miraculous', m:5, c:0},
    {name:'Bork the Wealthy',     m:2, c:30},
  ];
  const SpecialInstructions = [
    "Do not shake, and definitely do not light on fire. I'll see you in the morning.",
    "Package contains a manuscript. Never open and keep out of reach of children and animals.",
    "Originally intended for a lover, but now? My mother.",
    "Very old. Over 5,000 years, it says. Handle with care.",
    "Wizard's eyes only. No naughty knights allowed.",
    "It is as though I find things to send you just to keep my knight employed.",
    "I found the attached in an inferno. I think it would be of great personal interest to you.",
    "There's a new tower going up on the cliffs in the Badlands. How tacky.",
    "It's my histories in bound volumes. The originals. Well, the onlys.",
    "Per our discussion. You may find my failed attempts disturbing, but it will be good for your garden.",
    "Firstly, I love goblins. To that end, I commit to returning this useless and unassuming artifact.",
    "A generation ago, this valley was home to more than just Wizards and Knaves.",
    "ATTACHED: A very small piece of my first oubliette. Don't do anything strange with it.",
    "Give this to the Violet Cloak, if you can. Please burn it at the address provided if no.",
    "This is everything I know about Wandering Ones, including one of their masks.",
    "Hey, Knight: Wizards are paranoid. They believe some of their order are dead and replaced by knights.",
    "I can't stay. Lanturns gathering by night, lighting up the hills. I'm already gone."
  ];

  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

  function makePackage(){
    const size = pick(Sizes);
    const weight = pick(Weights);
    const grip = pick(Grips);
    const type = pick(Types);
    const dest = pick(Destinations);
    const sender = pick(Senders);
    const note = pick(SpecialInstructions);
    const baseCoin = size.c + weight.c + grip.c + type.c;
    const coinTotal = baseCoin + sender.c;
    const manaBonus = sender.m;

    const name = `${capitalize(type.name)}`;
    const descLines = [
      `A ${size.name}, ${weight.name}, ${grip.name} ${type.name}.`,
      `Base value: ${baseCoin} coin(s).`,
      `Destination: ${dest}`,
      `Sender: ${sender.name} (m${sender.m}${sender.c?`, c${sender.c}`:''})`,
      ``,
      note
    ];
    const desc = descLines.join('\n');

    const chip = document.createElement('div');
    chip.className = 'pkg';
    chip.dataset.name = name;
    chip.dataset.icon = type.icon;
    chip.dataset.desc = desc;
    chip.dataset.coinsBase = baseCoin;
    chip.dataset.coinsSender = sender.c;
    chip.dataset.coinsTotal = coinTotal;
    chip.dataset.manaSender = manaBonus;
    chip.innerHTML = `
      <div class="icon">${type.icon}</div>
      <div class="tag">${capitalize(type.name)}</div>
    `;
    return chip;
  }

  // Activate generates a new package into the portal slot (replacing any existing one)
  btnActivate.addEventListener('click', (e) => {
    e.stopPropagation();
    if (mana < 15) return;
    mana -= 15;
    updateCurrencyUI();

    const chip = makePackage();
    portalSlot.replaceChildren(chip);
  });

  // Begin Delivery — runs Knight vs Wandering Blade, logs to Delivery panel
  btnBegin.addEventListener('click', async (e) => {
    e.stopPropagation();
    if (btnBegin.disabled) return;

    // Optional: clear log first
    clearBattleLog();

    // Dynamic import so we don't have to convert the whole file to type="module"
    const { runAutobattle } = await import('./autobattle.js');

    const result = runAutobattle({ fighters: ['Knight','Wandering Blade'] });
    // Stream the log so it "plays out"
    playLog(result.log, 40);
    // (Later: reward coins/mana on victory, consume package, etc.)
  });

  // ===== Click-to-move selection/placement =====
  let selectedChip = null;
  let selectedFrom = null;

  function makePlaceholderFor(slot){
    const ph = document.createElement('div');
    ph.className = 'placeholder';
    ph.textContent = slot.classList.contains('knight-slot') ? 'no package' : 'empty';
    return ph;
  }

  function selectChip(chip){
    if (selectedChip) selectedChip.classList.remove('is-selected');
    selectedChip = chip;
    selectedFrom = chip.parentElement;
    chip.classList.add('is-selected');
    board.classList.add('board-selecting');
  }

  function clearSelection(){
    if (selectedChip) selectedChip.classList.remove('is-selected');
    selectedChip = null;
    selectedFrom = null;
    board.classList.remove('board-selecting');
  }

  function moveChipTo(slot){
    if (!selectedChip) return;
    if (slot === selectedFrom){ clearSelection(); return; }

    slot.replaceChildren(selectedChip);

    if (selectedFrom && selectedFrom.children.length === 0){
      selectedFrom.appendChild(makePlaceholderFor(selectedFrom));
    }

    const ph = slot.querySelector('.placeholder');
    if (ph) ph.remove();

    clearSelection();
    updateBeginEnabled(); // <-- re-evaluate button after any move
  }

  // ===== Long-press detection (mouse & touch) for package info =====
  const LONG_PRESS_MS = 550, MOVE_CANCEL_PX = 10;
  let lpTimer = null, lpStartX = 0, lpStartY = 0, longPressTriggered = false;

  function startLongPress(e, chip){
    if (!chip) return;
    longPressTriggered = false;
    const p = getPoint(e);
    lpStartX = p.x; lpStartY = p.y;
    clearTimeout(lpTimer);
    lpTimer = setTimeout(() => { longPressTriggered = true; openPkgOverlay(chip); }, LONG_PRESS_MS);
  }
  function moveLongPress(e){
    if (!lpTimer) return;
    const p = getPoint(e);
    if (Math.abs(p.x - lpStartX) > MOVE_CANCEL_PX || Math.abs(p.y - lpStartY) > MOVE_CANCEL_PX) clearTimeout(lpTimer), lpTimer=null;
  }
  function endLongPress(){ clearTimeout(lpTimer); lpTimer=null; }
  function getPoint(e){
    if (e.touches && e.touches[0]) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
    if (e.changedTouches && e.changedTouches[0]) return { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY };
    return { x: e.clientX ?? 0, y: e.clientY ?? 0 };
  }

  board.addEventListener('contextmenu', (e)=> { if (e.target.closest('.pkg')) e.preventDefault(); });
  board.addEventListener('mousedown', (e) => { const chip = e.target.closest('.pkg'); if (!chip) return; startLongPress(e, chip); });
  board.addEventListener('mousemove', moveLongPress);
  board.addEventListener('mouseup', endLongPress);
  board.addEventListener('mouseleave', endLongPress);
  board.addEventListener('touchstart', (e) => { const chip = e.target.closest('.pkg'); if (!chip) return; startLongPress(e, chip); }, { passive:true });
  board.addEventListener('touchmove', moveLongPress, { passive:true });
  board.addEventListener('touchend', endLongPress);
  board.addEventListener('touchcancel', endLongPress);

  // Click handler (selection / placement) — ignore if a long-press just fired
  board.addEventListener('click', (e) => {
    if (e.target.closest('button')) return;
    if (longPressTriggered) { longPressTriggered = false; return; }

    const chip = e.target.closest('.pkg');
    const slot = e.target.closest(SLOT_SEL);

    if (chip){ e.stopPropagation(); selectChip(chip); return; }
    if (slot){ moveChipTo(slot); return; }
    clearSelection();
  });

  // ===== Overlay for package details =====
  function openPkgOverlay(chip){
    const name = chip.dataset.name || chip.querySelector('.tag')?.textContent?.trim() || 'Package';
    const icon = chip.dataset.icon || chip.querySelector('.icon')?.textContent?.trim() || '📦';
    const desc = chip.dataset.desc || 'No description available.';
    const coinsTotal = chip.dataset.coinsTotal ?? '?';
    const coinsBase  = chip.dataset.coinsBase ?? '?';
    const manaSender = chip.dataset.manaSender ?? '0';

    const backdrop = document.createElement('div');
    backdrop.className = 'overlay-backdrop';
    backdrop.setAttribute('role', 'dialog'); backdrop.setAttribute('aria-modal', 'true');

    const card = document.createElement('div');
    card.className = 'overlay-card';
    card.innerHTML = `
      <div class="overlay-header">
        <div class="overlay-title">Package Details</div>
        <button class="overlay-close" type="button" aria-label="Close">✕</button>
      </div>
      <div class="overlay-body">
        <div class="overlay-icon">${icon}</div>
        <div class="overlay-texts">
          <div class="overlay-name">${name}</div>
          <div class="overlay-desc">${desc}</div>
          <div class="overlay-metrics">Total coin on return: <b>${coinsTotal}</b> (base ${coinsBase}${chip.dataset.coinsSender?` + sender ${chip.dataset.coinsSender}`:''}); Mana bonus on return: <b>m${manaSender}</b></div>
        </div>
      </div>
    `;
    backdrop.appendChild(card);
    document.body.appendChild(backdrop);

    function close(){
      document.removeEventListener('keydown', onKey);
      backdrop.removeEventListener('click', onBackdrop);
      backdrop.remove();
    }
    function onBackdrop(ev){ if (ev.target === backdrop || ev.target.classList.contains('overlay-close')) close(); }
    function onKey(ev){ if (ev.key === 'Escape') close(); }

    backdrop.addEventListener('click', onBackdrop);
    document.addEventListener('keydown', onKey);
  }
})();
</script>
</body>
</html>
